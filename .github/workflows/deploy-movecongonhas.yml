name: Deploy to CloudPanel - movecongonhas.org.br

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Instalar dependências e buildar (usar pnpm via Corepack)
        run: |
            # Enable Corepack and prepare the pnpm version pinned in the repo
            corepack enable
            corepack prepare pnpm@10.4.1 --activate || true
            pnpm install --frozen-lockfile
            pnpm run build

      - name: Deploy via rsync (write key safely + debug)
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          # Write private key, strip any Windows CRLFs that may be present in the secret
          echo "$DEPLOY_KEY" | tr -d '\r' > deploy_key
          chmod 600 deploy_key

          # Quick SSH connectivity debug (temporary): show why authentication fails if it does.
          # This will print ssh debug lines (methods tried, keys offered) without exposing the secret.
          ssh -i deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes -vvv root@72.60.144.123 'echo SSH_OK' || true

          # If the ssh debug above succeeded, run rsync. If it failed, rsync will likely also fail.
          rsync -avz -e "ssh -i deploy_key -o StrictHostKeyChecking=no" --delete dist/ root@72.60.144.123:/home/movecongonhas/htdocs/movecongonhas.org.br/
